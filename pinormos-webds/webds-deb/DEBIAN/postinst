#!/bin/sh

# Post-installation shell script for Debian package

USER=dsdkuser
WORKSPACE=/home/$USER/jupyter/workspace
SYNADIR=$WORKSPACE/Synaptics

SYSTEMD=/etc/systemd/system
SERVICE=jupyterlab.service

PYTHONLIBDIR=/usr/local/syna/lib/python

#find /var/spool/syna/webds/wheels -name webds_* -exec sh -c "yes 2>/dev/null | sudo pip3 install {}" \;
sudo pip3 install -r /var/spool/syna/webds/wheels/requirements.txt --no-index --find-links /var/spool/syna/webds/wheels

# Populate documentation inside Synaptics directory within JupyterLab workspace
sudo unzip /var/spool/syna/webds/docs/asicprogrammer_html.zip -d $SYNADIR/Documentation/User_Guides/AsicProgrammer
sudo unzip /var/spool/syna/webds/docs/touchcomm_html.zip -d $SYNADIR/Documentation/User_Guides/TouchComm
sudo cp /var/spool/syna/webds/docs/511-000746-01_RevL_TouchComm.pdf $SYNADIR/Documentation/Specifications/TouchComm_Protocol/.
sudo cp /var/spool/syna/webds/docs/webds_api.yaml $SYNADIR/Documentation/WebDS_API/.
sudo cp /var/spool/syna/webds/docs/readme.md $SYNADIR/.
sudo ln -sf $SYNADIR/Documentation/User_Guides/AsicProgrammer/classprogrammer_1_1asic__programmer_1_1_asic_programmer.html $SYNADIR/Documentation/User_Guides/AsicProgrammer/AsicProgrammer_User_Guide
sudo ln -sf $SYNADIR/Documentation/User_Guides/TouchComm/classtouch__comm_1_1_touch_comm.html $SYNADIR/Documentation/User_Guides/TouchComm/TouchComm_User_Guide
sudo ln -sf $SYNADIR/readme.md $SYNADIR/_links/README
sudo ln -sf /var/log/syna/update_daemon.log $SYNADIR/_links/Update_Daemon_Log
sudo ln -sf /var/log/syna/production_tests.log $SYNADIR/_links/Production_Tests_Log
sudo ln -sf /proc/tcm-i2c-log $SYNADIR/_links/I2C_Log
sudo ln -sf /proc/tcm-spi-log $SYNADIR/_links/SPI_Log
sudo ln -f /var/log/syslog $SYNADIR/_links/Syslog
sudo chown root:root $SYNADIR/_links/Syslog
sudo chmod 444 $SYNADIR/_links/Syslog

# Populate sample code inside Synaptics directory within JupyterLab workspace
sudo cp -r /var/spool/syna/webds/examples/* $SYNADIR/Sample_Code/.

# Install Plotter Python library
sudo rm -fr $PYTHONLIBDIR/plotter
sudo cp -r /var/spool/syna/webds/plotter $PYTHONLIBDIR/plotter

# Install backend package for production tests
sudo rm -fr $PYTHONLIBDIR/production_tests/lib
sudo rm -fr $PYTHONLIBDIR/production_tests/run
#sudo rm -fr $PYTHONLIBDIR/production_tests/sets
sudo rm -fr $PYTHONLIBDIR/production_tests/wrapper
sudo mkdir -p $PYTHONLIBDIR/production_tests
sudo cp -nr /var/spool/syna/webds/production_tests/* $PYTHONLIBDIR/production_tests/.
 
# Remove internal content from external releases
if grep -q ^VERSION_ID=\".*E\"$ /usr/lib/os-release; then
  sudo rm -fr $SYNADIR/_links/I2C_Log
  sudo rm -fr $SYNADIR/_links/SPI_Log
  sudo rm -fr $SYNADIR/_links/Syslog
  sudo rm -fr $SYNADIR/Documentation/User_Guides/AsicProgrammer
  sudo rm -fr $SYNADIR/Sample_Code/erase_and_program.ipynb
  sudo rm -fr $PYTHONLIBDIR/programmer
  sudo cp -r /var/spool/syna/webds/programmer $PYTHONLIBDIR/programmer
fi

if [ -f $SYSTEMD/$SERVICE ]; then
  systemctl is-active $SERVICE > /dev/null 2>&1 && sudo systemctl restart $SERVICE
fi
